# 特权指令系统

## 简介

​	现代计算机的指令系统在用户态子集之外还定义了特权态部分，称之为特权指令系统。

​	指令系统根据机制分类：

- 运行模式定义及其转换
    - 现代计算机操作系统都实现了保护模式，设计为用户态与核心态两种运行模式。
    - 应用运行在用户态模式下，操作系统运行在核心态模式下。
- 虚拟存储管理
    - 基本思想是让软件运行在“虚地址”上，与真正访问、存储的物理地址相隔离。
    - 虚实地址的转化，根据地址段属性的不同，分为 查表转化 和 直接映射。
- 异常与中断
    - 异常与中断是一种打断正常的软件执行流，切换到专门的处理函数的机制。
- 控制寄存器
    - 控制寄存器位于一个独立的地址空间，是支撑前面3种机制的具体实现。

## 异常与中断

### 异常分类

​	根据来源划分异常：

- 外部事件
    - 来自CPU核外部的事件，来自处理器内部其他模块或者处理器外部的真实物理连线。
    - 也称为 中断。
- 指令执行中的错误
    - 执行中的指令的操作码或操作数不符合要求
- 数据完整性问题
    - 当使用ECC等硬件校验方式的存储器发生校验错误时，会产生异常
- 地址转换异常
    - 在存储管理单元需要对一个内存页进行抵制转换，而硬件转换表没有有效的转换对应项可用时，会产生异常
- 系统调用和陷入
    - 由专有指令产生，目的是产生操作系用可识别异常，用于在保护模式下调用核心态相关操作
- 需要软件修正的运算
    - 某些操作和操作数的组合硬件由于实现的原因不愿意处理，寻求软件的帮助

### 异常处理

​	异常的处理流程

- 异常处理准备
    - 异常发生，CPU转而执行异常处理前，硬件需要进行一系列准备工作
    - 精确异常：发生任何异常时，被异常打断的指令（记为EPTR）前所有的指令都执行完，而EPTR及以后的所有指令都像没执行一样。
- 确定异常来源
    - 处理器将不同异常进行编号，以便异常处理程序进行区分和跳转。
- 保存执行状态
    - 在进行异常处理前，先保存被打断的程序状态，通常至少需要将通用寄存器和程序状态字寄存器的值保存到栈中。
    - 根据需要关闭或保留部分中断使能，防止异常处理过程中产生新的中断影响程序执行状态。
- 处理异常
    - 跳转到对应异常处理程序进行异常处理。
- 恢复执行状态并返回
    - 恢复通用寄存器的值，并执行异常返回指令。

### 中断

MIPS处理器中断输入分类：

- 可屏蔽中断（INT）
    - 可通过协处理器寄存器SR来进行屏蔽
- 不可屏蔽异常（NMI）
    - 若没有特定处理，触发NMI会直接导致系统重启
    - NMI的触发通常来源于硬件预设的致命错误

中断的优先级和原子性

- 当有必要时，可以通过软件来实现中断优先级方案
    - 软件随时维护一个中断优先级（IPL），每个中断源都被赋予特定的优先级
    - 正常状态下，CPU运行在最低优先级，此时任何中断都可触发
    - 当处于最高中断优先级时，任何中断都被禁止
    - 更高优先级的中断发生时，可以抢占低优先级的中断处理过程

向量化中断

- 

中断传递机制

- 中断 从系统中各个 中断源 传递到 处理器主要有两种形式：中断线、消息中断
- 中断线
    - 若中断源不多，直接连到处理器引脚；若中断源较多，可使用中断控制器汇总后再与处理器引脚相连
    - 由于连线会占用引脚资源，一般只在SoC中才会给每个外设连单独的中断线；板级中断线一般采用共享方式
    - 存在的限制：
        - 扩展性不够强
        - 中断处理过程中需要通过查询中断控制以及设备上的状态寄存器来确认中断和中断原因，中间有较长延迟
        - 在多处理器平台，高性能外设对中断处理性能有较高要求，中断线方式难以做到
- 消息中断
    - 以数据方式在总线上传递中断。发中断就是往指定的地址写一个指定的数
    - 增加中断时不需要改动消息传递的通路，有较高扩展性、灵活性

## 存储管理

### 存储管理原理

​	存储管理构建虚拟的内存地址，并通过MMU进行虚拟地址到物理地址的转换。

​	存储管理的作用和意义：

- 隐藏和保护
    - 用户态程序追能访问useg内存区域的数据；其他数据只能由核心态程序访问。
    - 分页的存储管理方法对每个页都有单独的写保护，核心态的操作系统可防止用户程序随意修改代码段。
- 为程序分配连续的内存空间
    - MMU可由分散的物理页构建连续的虚拟内存空间，以页为单元管理物理内存分配。
- 扩展地址空间
- 节约物理内存

### TLB的结构和使用



### TLB异常处理

